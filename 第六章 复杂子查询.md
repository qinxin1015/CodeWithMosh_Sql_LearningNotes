# 复杂子查询
- 本章会更深入地了解一下复杂的子查询
- 在开始之前，需要将数据库再次恢复到初始状态

### 6.2 
```sql
USE sql_store;
-- Find products that are more expensive than Lettuce (id = 3)
-- 2 step queries
-- 1. select Lettuce unit_price when product_id = 3
-- 2. select everything which unit_price > Lettuce unit_price
SELECT * 
FROM products
WHERE unit_price > (
SELECT unit_price
FROM products
WHERE product_id = 3
);
-- 这个子查询卸载where子句里，其实也可以写在from子句和select子句里，我们后面会讲到
```
#### 练习
```sql
-- In sql_hr database
-- 		Find employees whoses earn more than average
USE sql_hr;

SELECT *
FROM employees
WHERE salary > (
	SELECT AVG(salary)
	FROM employees
);
```
### 6.3-6.4 子查询 VS 联表查询
```sql
-- Find the products that have never been ordered
USE sql_store;
-- Solution 1
SELECT 
	p.product_id,
    p.name
FROM products p
LEFT JOIN order_items oi
	USING(product_id)
WHERE order_id IS NULL;

-- Solution 2 使用子查询
SELECT 
	product_id,
    name
FROM products 
WHERE product_id NOT IN (
	SELECT DISTINCT product_id
	FROM order_items
);

```
#### 练习 6.3
```sql
-- Find clients without invoices
USE sql_invoicing;
-- Solution 1  联表查询
SELECT 
	c.client_id, 
    c.name
FROM clients c
LEFT JOIN invoices i USING (client_id)
WHERE invoice_id IS NULL;

-- Solution 1  子查询
SELECT 
	client_id, 
    name
FROM clients 
WHERE client_id NOT IN (
	SELECT DISTINCT client_id
	FROM invoices 
);
```
#### 练习 6.4
```sql
-- Find customers who have ordered lettuce (id = 3)
-- 		Select customer_id, first_name, last_name
USE sql_store;
-- Solution 1 子连接 （3层查询）
SELECT 
	customer_id, 
	first_name, 
	last_name
FROM customers
WHERE customer_id IN (
	SELECT customer_id
    FROM orders
    WHERE order_id IN (
    	SELECT order_id 
		FROM order_items
		WHERE product_id = 3
    )
);

-- Solution 2 联表查询
SELECT DISTINCT
	c.customer_id, 
	c.first_name, 
	c.last_name
FROM customers c
JOIN orders o USING (customer_id)
JOIN order_items oi USING (order_id)
WHERE oi.product_id = 3;
```
### 6.5 ALL 关键字
```sql
-- Select invocies larger than all invoices of client 3
USE sql_invoicing;
-- Solution 1 子查询
SELECT *
FROM invoices
WHERE invoice_total > (
	SELECT Max(invoice_total)
	FROM invoices
	WHERE client_id = 3
);

-- Solution 2 ALL 关键字
SELECT *
FROM invoices
WHERE invoice_total > ALL(
	SELECT invoice_total
	FROM invoices
	WHERE client_id = 3
);
```
### 6.6 ANY 关键字
```sql

```
#### 练习
```sql

```